import { ethers } from "ethers";

// Chiliz Spicy Testnet configuration
const CHILIZ_SPICY_RPC = "https://spicy-rpc.chiliz.com";
const CHILIZ_SPICY_CHAIN_ID = 88882;

// Contract ABI for CustomToken - only the parts we need
const CUSTOM_TOKEN_ABI = [
  "constructor(string memory name, string memory symbol, uint256 initialSupply, uint8 decimals)",
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)"
];

// Compiled bytecode from hardhat-token/artifacts
// This needs to be updated with the actual compiled bytecode
const CUSTOM_TOKEN_BYTECODE = "0x608060405234801561000f575f5ffd5b5060405161102638038061102683398181016040528101906100319190610309565b8373ffffffffffffffffffffffffffffffffffffffff1660015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600290816100969190610590565b5081600390816100a69190610590565b5080600460146101000a81548160ff021916908360ff16021790555060015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff165f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a360015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff165f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506101e23360015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff168460ff16600a6101eb9190610790565b866101f691906107da565b610200565b5050505061084e565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361026e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161026590610873565b60405180910390fd5b6102775f83610305565b8060055f8282546102889190610891565b925050819055508060065f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546102db9190610891565b925050819055508173ffffffffffffffffffffffffffffffffffffffff165f73ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161033f91906108d3565b60405180910390a35050565b505050565b5f604051905090565b5f5ffd5b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6103888261035f565b9050919050565b6103988161037e565b81146103a2575f5ffd5b50565b5f815190506103b38161038f565b92915050565b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610408826103c2565b810181811067ffffffffffffffff82111715610427576104266103d2565b5b80604052505050565b5f610439610348565b905061044582826103ff565b919050565b5f67ffffffffffffffff821115610464576104636103d2565b5b61046d826103c2565b9050602081019050919050565b5f5b8381101561049757808201518184015260208101905061047c565b5f8484015250505050565b5f6104b46104af8461044a565b610430565b9050828152602081018484840111156104d0576104cf6103be565b5b6104db84828561047a565b509392505050565b5f82601f8301126104f7576104f66103ba565b5b81516105078482602086016104a2565b91505092915050565b5f819050919050565b61052281610510565b811461052c575f5ffd5b50565b5f8151905061053d81610519565b92915050565b5f60ff82169050919050565b61055881610543565b8114610562575f5ffd5b50565b5f815190506105738161054f565b92915050565b5f5f5f5f6080858703121561059157610590610351565b5b5f6105a0878288016103a5565b945050602085015167ffffffffffffffff8111156105c1576105c0610355565b5b6105cd878288016104e3565b935050604085015167ffffffffffffffff8111156105ee576105ed610355565b5b6105fa878288016104e3565b925050606061060b8782880161052f565b91505092959194509250565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061066557607f821691505b6020821081036106785761067761062f565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026106da7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261069f565b6106e4868361069f565b95508019841693508086168417925050509392505050565b5f819050919050565b5f61071f61071a61071584610510565b6106fc565b610510565b9050919050565b5f819050919050565b61073883610705565b61074c61074482610726565b8484546106ab565b825550505050565b5f5f905090565b610763610754565b61076e81848461072f565b505050565b5b8181101561079157610786575f8261075b565b600181019050610774565b5050565b601f8211156107d6576107a78161067e565b6107b084610690565b810160208510156107bf578190505b6107d36107cb85610690565b830182610773565b50505b505050565b5f82821c905092915050565b5f6107f65f19846008026107db565b1980831691505092915050565b5f61080e83836107e7565b9150826002028217905092915050565b61082782610617565b67ffffffffffffffff8111156108405761083f6103d2565b5b61084a825461065c565b610855828285610792565b5f60209050601f831160018114610886575f8415610874578287015190505b61087e8582610803565b8655506108e5565b601f1984166108948661067e565b5f5b828110156108bb57848901518255600182019150602085019450602081019050610896565b868310156108d857848901516108d4601f8916826107e7565b8355505b6001600288020188555050505b505050505050565b610780806108fb5f395ff3fe608060405234801561000f575f5ffd5b5060043610610091575f3560e01c806370a082311161006457806370a08231146101185780638da5cb5b1461014857806395d89b4114610166578063a9059cbb14610184578063dd62ed3e146101b457610091565b806306fdde0314610095578063095ea7b3146100b357806318160ddd146100e357806323b872dd14610101575b5f5ffd5b61009d6101e4565b6040516100aa91906104b5565b60405180910390f35b6100cd60048036038101906100c89190610566565b610274565b6040516100da91906105be565b60405180910390f35b6100eb610296565b6040516100f891906105e6565b60405180910390f35b61011b600480360381019061011691906105ff565b61029f565b60405161012891906105be565b60405180910390f35b610132600480360381019061012d919061064f565b6102cd565b60405161013f91906105e6565b60405180910390f35b610150610312565b60405161015d919061067a565b60405180910390f35b61016e610337565b60405161017b91906104b5565b60405180910390f35b61019e60048036038101906101999190610566565b6103c7565b6040516101ab91906105be565b60405180910390f35b6101ce60048036038101906101c99190610693565b6103e9565b6040516101db91906105e6565b60405180910390f35b6060600280546101f3906106fe565b80601f016020809104026020016040519081016040528092919081815260200182805461021f906106fe565b801561026a5780601f106102415761010080835404028352916020019161026a565b820191905f5260205f20905b81548152906001019060200180831161024d57829003601f168201915b5050505050905090565b5f8061027e61046b565b905061028b818585610472565b600191505092915050565b5f600554905090565b5f806102a961046b565b90506102b6858285610484565b6102c1858585610516565b60019150509392505050565b5f60065f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050919050565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b606060038054610346906106fe565b80601f0160208091040260200160405190810160405280929190818152602001828054610372906106fe565b80156103bd5780601f10610394576101008083540402835291602001916103bd565b820191905f5260205f20905b8154815290600101906020018083116103a057829003601f168201915b5050505050905090565b5f806103d161046b565b90506103de818585610516565b600191505092915050565b5f60075f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905092915050565b5f33905090565b61047f8383836001610606565b505050565b5f61048f84846103e9565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146105105781811015610501578281836040517ffb8f41b20000000000000000000000000000000000000000000000000000000081526004016104f89392919061073d565b60405180910390fd5b61050f84848484035f610606565b5b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610586575f6040517f96c6fd1e00000000000000000000000000000000000000000000000000000000815260040161057d9190610772565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036105f6575f6040517fec442f050000000000000000000000000000000000000000000000000000000081526004016105ed9190610772565b60405180910390fd5b6106018383836107d5565b505050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603610676575f6040517fe602df0500000000000000000000000000000000000000000000000000000000815260040161066d9190610772565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036106e6575f6040517f94280d620000000000000000000000000000000000000000000000000000000081526004016106dd9190610772565b60405180910390fd5b8160075f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055508015610775578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516107cc91906105e6565b60405180910390a35b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610825578060055f82825461081991906107b8565b925050819055506108f3565b5f60065f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050818110156108af578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016108a69392919061073d565b60405180910390fd5b818103 60065f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361093a578060055f82825403925050819055506109845760065f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825461097891906107b8565b92505081905550505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516109dd91906105e6565b60405180910390a3505050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f610a2f826109ea565b610a3981856109f4565b9350610a49818560208601610a04565b610a5281610a12565b840191505092915050565b5f6020820190508181035f830152610a758184610a25565b905092915050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610aaa82610a81565b9050919050565b610aba81610aa0565b8114610ac4575f5ffd5b50565b5f81359050610ad581610ab1565b92915050565b5f819050919050565b610aed81610adb565b8114610af7575f5ffd5b50565b5f81359050610b0881610ae4565b92915050565b5f5f60408385031215610b2457610b23610a7d565b5b5f610b3185828601610ac7565b9250506020610b4285828601610afa565b9150509250929050565b5f8115159050919050565b610b6081610b4c565b82525050565b5f602082019050610b795f830184610b57565b92915050565b610b8881610adb565b82525050565b5f602082019050610ba15f830184610b7f565b92915050565b5f5f5f60608486031215610bbe57610bbd610a7d565b5b5f610bcb86828701610ac7565b9350506020610bdc86828701610ac7565b9250506040610bed86828701610afa565b9150509250925092565b5f60208284031215610c0c57610c0b610a7d565b5b5f610c1984828501610ac7565b91505092915050565b610c2b81610aa0565b82525050565b5f602082019050610c445f830184610c22565b92915050565b5f5f60408385031215610c6057610c5f610a7d565b5b5f610c6d85828601610ac7565b9250506020610c7e85828601610ac7565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610ccd57607f821691505b602082108103610ce057610cdf610c88565b5b50919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610d1e82610adb565b9150610d2983610adb565b9250828201905080821115610d4157610d40610ce6565b5b92915050565b610d5081610aa0565b82525050565b610d5f81610adb565b82525050565b5f606082019050610d785f830186610d47565b610d856020830185610d56565b610d926040830184610d56565b94935050505056fea2646970667358221220"; // Truncated for brevity - needs actual bytecode

/**
 * Deploy token endpoint
 * POST /api/deploy-token
 * Body: { tokenName, tokenSymbol, initialSupply, decimals, walletAddress }
 */
export default async function handler(req, res) {
  // Set CORS headers
  res.setHeader("Access-Control-Allow-Credentials", "true");
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET,OPTIONS,PATCH,DELETE,POST,PUT");
  res.setHeader(
    "Access-Control-Allow-Headers",
    "X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"
  );

  // Handle preflight
  if (req.method === "OPTIONS") {
    res.status(200).end();
    return;
  }

  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const { tokenName, tokenSymbol, initialSupply = "1000000", decimals = "18" } = req.body;

    // Validation
    if (!tokenName || !tokenSymbol) {
      return res.status(400).json({ 
        error: "Token name and symbol are required" 
      });
    }

    // Get deployer private key from environment
    const privateKey = process.env.PRIVATE_KEY;
    if (!privateKey) {
      return res.status(500).json({ 
        error: "Server configuration error: PRIVATE_KEY not set" 
      });
    }

    console.log("Deploying token:", { tokenName, tokenSymbol, initialSupply, decimals });

    // Connect to Chiliz Spicy Testnet
    const provider = new ethers.JsonRpcProvider(CHILIZ_SPICY_RPC, {
      name: "chiliz-spicy-testnet",
      chainId: CHILIZ_SPICY_CHAIN_ID
    });

    // Create wallet/signer
    const wallet = new ethers.Wallet(privateKey, provider);
    const balance = await provider.getBalance(wallet.address);
    
    console.log("Deployer address:", wallet.address);
    console.log("Balance:", ethers.formatEther(balance), "CHZ");

    if (balance === 0n) {
      return res.status(400).json({ 
        error: "Insufficient balance for deployment. Please fund the deployer wallet." 
      });
    }

    // Read the compiled contract
    const fs = await import("fs");
    const path = await import("path");
    
    // Get the artifact from hardhat-token build
    const artifactPath = path.join(process.cwd(), "hardhat-token", "artifacts", "contracts", "CustomToken.sol", "CustomToken.json");
    
    let contractFactory;
    try {
      const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));
      contractFactory = new ethers.ContractFactory(artifact.abi, artifact.bytecode, wallet);
    } catch (err) {
      return res.status(500).json({ 
        error: "Contract artifact not found. Please compile the contract first.",
        details: err.message
      });
    }

    // Deploy the contract
    console.log("Deploying contract...");
    const contract = await contractFactory.deploy(
      tokenName,
      tokenSymbol,
      parseInt(initialSupply),
      parseInt(decimals)
    );

    console.log("Waiting for deployment...");
    await contract.waitForDeployment();
    
    const contractAddress = await contract.getAddress();
    console.log("Token deployed to:", contractAddress);

    // Get token details
    const name = await contract.name();
    const symbol = await contract.symbol();
    const totalSupply = await contract.totalSupply();

    return res.status(200).json({
      success: true,
      contractAddress,
      name,
      symbol,
      totalSupply: ethers.formatUnits(totalSupply, parseInt(decimals)),
      decimals: parseInt(decimals),
      network: "chilizSpicy",
      explorerUrl: `https://testnet.chiliscan.com/address/${contractAddress}`,
      deployerAddress: wallet.address
    });

  } catch (error) {
    console.error("Deployment error:", error);
    return res.status(500).json({ 
      error: "Deployment failed", 
      details: error.message 
    });
  }
}

